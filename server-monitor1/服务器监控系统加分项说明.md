# 服务器监控系统加分项简化说明文档



```
\# 服务器监控系统加分项简化说明文档

\## 一、Docker容器化部署类

\### 1. 监控应用全容器化部署

\- \*\*功能\*\*：通过Docker Compose一键编排前端、后端、MySQL服务，实现环境隔离与快速部署。

\- \*\*代码片段\*\*（\`docker-compose.yml\`）：

\`\`\`yaml

version: '3.8'

services:

&#x20; frontend:

&#x20;   build: ./frontend

&#x20;   ports: \["3000:3000"]

&#x20;   environment:

&#x20;     \- BACKEND\_URL=http://backend:5000

&#x20;   depends\_on: \["backend"]

&#x20;   restart: always

&#x20; backend:

&#x20;   build: ./backend

&#x20;   ports: \["5000:5000"]

&#x20;   environment:

&#x20;     \- MYSQL\_HOST=mysql

&#x20;     \- MYSQL\_USER=monitor\_user

&#x20;   depends\_on: \["mysql"]

&#x20;   restart: always

&#x20;   volumes: \["./backend/logs:/app/logs"]

&#x20; mysql:

&#x20;   image: mysql:8.0

&#x20;   ports: \["3307:3306"]

&#x20;   environment:

&#x20;     \- MYSQL\_ROOT\_PASSWORD=Root\_Encrypted

&#x20;     \- MYSQL\_DATABASE=server\_monitor

&#x20;     \- MYSQL\_USER=monitor\_user

&#x20;     \- MYSQL\_PASSWORD=Encrypted\_123

&#x20;   volumes: \["mysql\_data:/var/lib/mysql"]

&#x20;   restart: always

volumes:

&#x20; mysql\_data:
```



* ![image-20251119211950257](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119211950257.png)



### 2. 容器数据持久化与自动重启



* **功能**：MySQL 数据卷独立存储，容器删除后数据不丢失；所有服务异常自动重启。

* **代码片段**（`docker-compose.yml` 核心部分）：



```
services:

&#x20; mysql:

&#x20;   volumes: \["mysql\_data:/var/lib/mysql"]  # 数据持久化

&#x20;   restart: always  # 异常自动重启

&#x20; frontend:

&#x20;   restart: always

&#x20; backend:

&#x20;   restart: always

volumes:

&#x20; mysql\_data:  # 命名数据卷
```



* ![image-20251119212024462](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212024462.png)



## 二、可视化增强类

### 1. 响应式深色主题界面



* **功能**：基于 Bootstrap 实现 PC 自适应布局，默认深色主题，提升视觉体验。

* **代码片段**（`frontend/index.html`）：



```
\<meta name="viewport" content="width=device-width, initial-scale=1.0">

\<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

\<style>

/\* 默认深色主题 \*/

body {

&#x20; background-color: #121212;

&#x20; color: #e0e0e0;

}

.card {

&#x20; background-color: #1e1e1e;

&#x20; border: none;

}

\</style>

\<!-- 响应式布局 -->

\<div class="container mt-4">

&#x20; \<div class="row">

&#x20;   \<div class="col-lg-3 col-12 mb-4">

&#x20;     \<div class="card p-3">主机列表\</div>

&#x20;   \</div>

&#x20;   \<div class="col-lg-9 col-12">

&#x20;     \<div class="card p-3">监控图表\</div>

&#x20;   \</div>

&#x20; \</div>

\</div>
```



![image-20251119212126225](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212126225.png)



## 三、功能扩展类

### 1. 容器状态监控



* **功能**：采集并展示被监控主机的 Docker 容器资源使用数据（CPU、内存、状态）。

* **代码片段**（`backend/``container_monitor.py`）：



```
import paramiko

import json

def get\_container\_metrics(host\_ip, ssh\_user, ssh\_password):

&#x20;   ssh = paramiko.SSHClient()

&#x20;   ssh.set\_missing\_host\_key\_policy(paramiko.AutoAddPolicy())

&#x20;   try:

&#x20;       ssh.connect(host\_ip, username=ssh\_user, password=ssh\_password, timeout=10)

&#x20;       # 采集容器资源数据

&#x20;       stdin, stdout, stderr = ssh.exec\_command(

&#x20;           "docker stats --no-stream --format '{{json .Container}} {{.CPUPerc}} {{.MemPerc}} {{.Name}}'"

&#x20;       )

&#x20;       containers = \[]

&#x20;       for line in stdout.read().decode().split('\n'):

&#x20;           if line.strip():

&#x20;               cid, cpu, mem, name = line.strip().replace('"', '').split(' ', 3)

&#x20;               containers.append({

&#x20;                   "container\_id": cid\[:12],

&#x20;                   "name": name,

&#x20;                   "cpu\_usage": cpu,

&#x20;                   "mem\_usage": mem,

&#x20;                   "status": "running"

&#x20;               })

&#x20;       return containers

&#x20;   finally:

&#x20;       ssh.close()
```

![image-20251119212205225](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212205225.png)

### 2. 监控数据 Excel 导出



* **功能**：支持将指定时间范围的 CPU、内存监控数据导出为 Excel 文件，便于离线分析。

* **代码片段**（前端 `frontend/index.html` 导出按钮）：

```
\<!-- 导出按钮 -->

\<div class="card p-3 mb-4">

&#x20; \<div class="d-flex justify-content-between align-items-center">

&#x20;   \<h5 class="mb-0">数据导出\</h5>

&#x20;   \<button id="exportExcelBtn" class="btn btn-success">导出Excel\</button>

&#x20; \</div>

\</div>

\<script>

// 导出Excel事件

document.getElementById('exportExcelBtn').addEventListener('click', async () => {

&#x20; try {

&#x20;   // 可添加时间范围选择逻辑，此处默认导出近24小时数据

&#x20;   const response = await fetch('/api/export/metrics', {

&#x20;     method: 'GET',

&#x20;     responseType: 'blob'

&#x20;   });

&#x20;   // 处理Excel文件下载

&#x20;   const blob = await response.blob();

&#x20;   const url = window.URL.createObjectURL(blob);

&#x20;   const a = document.createElement('a');

&#x20;   a.href = url;

&#x20;   a.download = \`监控数据\_\${new Date().toLocaleDateString()}.xlsx\`;

&#x20;   document.body.appendChild(a);

&#x20;   a.click();

&#x20;   window.URL.revokeObjectURL(url);

&#x20;   document.body.removeChild(a);

&#x20; } catch (error) {

&#x20;   alert('导出失败：' + error.message);

&#x20; }

});

\</script>
```

* **代码片段**（后端 `backend/``export_service.py`）：

```
import pandas as pd

from datetime import datetime, timedelta

from flask import make\_response

import io

def export\_metrics\_to\_excel():

&#x20;   """导出近24小时监控数据为Excel"""

&#x20;   # 1. 查询数据库近24小时数据

&#x20;   conn = get\_db\_connection()

&#x20;   end\_time = datetime.now()

&#x20;   start\_time = end\_time - timedelta(days=1)

&#x20;   try:

&#x20;       with conn.cursor(pymysql.cursors.DictCursor) as cursor:

&#x20;           cursor.execute('''

&#x20;               SELECT host\_ip, cpu\_usage, mem\_usage, collect\_time&#x20;

&#x20;               FROM metrics&#x20;

&#x20;               WHERE collect\_time BETWEEN %s AND %s

&#x20;               ORDER BY collect\_time DESC

&#x20;           ''', (start\_time.strftime('%Y-%m-%d %H:%M:%S'), end\_time.strftime('%Y-%m-%d %H:%M:%S')))

&#x20;           data = cursor.fetchall()

&#x20;   finally:

&#x20;       conn.close()

&#x20;   # 2. 转换为DataFrame并生成Excel

&#x20;   df = pd.DataFrame(data)

&#x20;   df.columns = \['主机IP', 'CPU使用率(%)', '内存使用率(%)', '采集时间']

&#x20;  &#x20;

&#x20;   # 3. 写入Excel流

&#x20;   output = io.BytesIO()

&#x20;   with pd.ExcelWriter(output, engine='openpyxl') as writer:

&#x20;       df.to\_excel(writer, sheet\_name='监控数据', index=False)

&#x20;  &#x20;

&#x20;   # 4. 构建响应

&#x20;   output.seek(0)

&#x20;   response = make\_response(output.getvalue())

&#x20;   response.headers\['Content-Type'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'

&#x20;   response.headers\['Content-Disposition'] = f'attachment; filename=监控数据\_{end\_time.strftime("%Y%m%d")}.xlsx'

&#x20;   return response

\# 后端接口注册（app.py中添加）

\# app.route('/api/export/metrics', methods=\['GET'])(export\_metrics\_to\_excel)
```

![image-20251119213601617](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119213601617.png)



## 四、自动化部署类

### 1. 一键部署脚本



* **功能**：自动安装 Docker、Ansible 依赖，一键启动所有服务。

* **代码片段**（`deploy.sh`）：



```
\#!/bin/bash

set -e

\# 安装Docker

install\_docker() {

&#x20; if ! command -v docker &> /dev/null; then

&#x20;   sudo apt update -y && sudo apt install -y docker.io docker-compose-plugin

&#x20;   sudo systemctl enable --now docker

&#x20;   sudo usermod -aG docker \$USER

&#x20; fi

}

\# 安装Ansible

install\_ansible() {

&#x20; if ! command -v ansible &> /dev/null; then

&#x20;   sudo apt update -y && sudo apt install -y ansible sshpass

&#x20; fi

}

\# 启动服务

start\_services() {

&#x20; docker compose down && docker compose up -d --build

&#x20; server\_ip=\$(hostname -I | awk '{print \$1}')

&#x20; echo "服务启动成功，访问地址：http://\$server\_ip:3000"

}

install\_docker

install\_ansible

start\_services
```



## 五、服务稳定性增强类

### 1. 数据库连接重试机制



* **功能**：数据库连接失败时自动重试 3 次，避免临时网络波动。

* **代码片段**（`backend/``app.py`）：



```
import pymysql

import time

DB\_CONFIG = {

&#x20;   'host': 'mysql',

&#x20;   'user': 'monitor\_user',

&#x20;   'password': 'Encrypted\_123',

&#x20;   'db': 'server\_monitor'

}

def get\_db\_connection():

&#x20;   max\_retries = 3

&#x20;   retry\_delay = 2

&#x20;   for retry in range(max\_retries):

&#x20;       try:

&#x20;           conn = pymysql.connect(\*\*DB\_CONFIG)

&#x20;           return conn

&#x20;       except Exception as e:

&#x20;           if retry < max\_retries - 1:

&#x20;               time.sleep(retry\_delay)

&#x20;               continue

&#x20;           raise Exception(f"数据库连接失败（已重试{max\_retries}次）：{str(e)}")
```

![image-20251119212318381](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212318381.png)

* 

### 2. 服务启动自检



* **功能**：启动前检查数据库初始化、定时任务状态，确保服务正常运行。

* **代码片段**（`backend/``app.py`）：



```
from apscheduler.schedulers.background import BackgroundScheduler

def init\_database():

&#x20;   conn = get\_db\_connection()

&#x20;   try:

&#x20;       with conn.cursor() as cursor:

&#x20;           cursor.execute('''

&#x20;               CREATE TABLE IF NOT EXISTS metrics (

&#x20;                   id INT AUTO\_INCREMENT PRIMARY KEY,

&#x20;                   host\_ip VARCHAR(20) NOT NULL,

&#x20;                   cpu\_usage FLOAT NOT NULL,

&#x20;                   mem\_usage FLOAT NOT NULL,

&#x20;                   collect\_time DATETIME DEFAULT CURRENT\_TIMESTAMP

&#x20;               )

&#x20;           ''')

&#x20;       conn.commit()

&#x20;   finally:

&#x20;       conn.close()

def scheduled\_data\_collection():

&#x20;   pass  # 数据采集逻辑

\# 启动自检

if \_\_name\_\_ == '\_\_main\_\_':

&#x20;   try:

&#x20;       init\_database()

&#x20;       scheduler = BackgroundScheduler()

&#x20;       scheduler.add\_job(scheduled\_data\_collection, 'interval', seconds=10)

&#x20;       scheduler.start()

&#x20;       app.run(host='0.0.0.0', port=5000)

&#x20;   except Exception as e:

&#x20;       print(f"启动失败：{str(e)}")

&#x20;       exit(1)
```

![image-20251119212424663](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212424663.png)



## 六、数据采集与处理类

### 1. 定时自动数据采集



* **功能**：每 10 秒自动采集所有主机的 CPU、内存数据。

* **代码片段**（`backend/``app.py`）：



```
def get\_all\_hosts():

&#x20;   conn = get\_db\_connection()

&#x20;   try:

&#x20;       with conn.cursor(pymysql.cursors.DictCursor) as cursor:

&#x20;           cursor.execute("SELECT ip, ssh\_user, ssh\_password FROM hosts")

&#x20;           return cursor.fetchall()

&#x20;   finally:

&#x20;       conn.close()

def collect\_host\_metrics(host):

&#x20;   return {

&#x20;       'host\_ip': host\['ip'],

&#x20;       'cpu\_usage': 25.3,  # 实际为解析结果

&#x20;       'mem\_usage': 42.1

&#x20;   }

def save\_metrics(metrics):

&#x20;   conn = get\_db\_connection()

&#x20;   try:

&#x20;       with conn.cursor() as cursor:

&#x20;           sql = "INSERT INTO metrics (host\_ip, cpu\_usage, mem\_usage) VALUES (%s, %s, %s)"

&#x20;           cursor.execute(sql, (metrics\['host\_ip'], metrics\['cpu\_usage'], metrics\['mem\_usage']))

&#x20;       conn.commit()

&#x20;   finally:

&#x20;       conn.close()

def scheduled\_data\_collection():

&#x20;   hosts = get\_all\_hosts()

&#x20;   for host in hosts:

&#x20;       try:

&#x20;           metrics = collect\_host\_metrics(host)

&#x20;           save\_metrics(metrics)

&#x20;       except Exception as e:

&#x20;           print(f"采集失败：{str(e)}")
```

![image-20251119212523872](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119212523872.png)



## 加分项汇总表



| 类别             | 加分项名称                      | 核心代码文件                                                 | 验证截图关键要求                                             |
| ---------------- | ------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Docker 容器化    | 全容器化部署                    | `docker-compose.yml`                                         | `docker-compose ps`显示所有容器`Up`                          |
| Docker 容器化    | 数据持久化 + 自动重启           | `docker-compose.yml`                                         | 重启容器后，Web 界面主机信息未丢失                           |
| 可视化增强       | 响应式深色主题界面              | `frontend/index.html`                                        | PC 端分栏 / 手机端堆叠布局截图                               |
| 功能扩展         | 容器监控                        | `backend/container_monitor.py`                               | Web 界面容器列表与 CPU / 内存数据表格                        |
| 自动化部署       | 一键部署脚本                    | `deploy.sh`                                                  | 浏览器成功打开 Web 界面的截图                                |
| 功能扩展         | 监控数据 Excel 导出             | `frontend/index.html`、`backend/export_service.py`           | 1. 前端导出按钮截图；2. 下载的 Excel 文件内容截图            |
| 服务稳定性       | 数据库连接重试                  | `backend/app.py`                                             | Web 界面正常展示数据库数据的截图                             |
| 服务稳定性       | 启动自检                        | `backend/app.py`                                             | Web 界面监控图表正常显示的截图                               |
| 数据采集功能扩展 | 定时自动采集监控数据 Excel 导出 | `backend/app.py``frontend/index.html`、`backend/export_service.py` | 监控图表 10 秒更新一次的动态截图1. 前端导出按钮截图；2. 下载的 Excel 文件内容截图 |



