# 服务器监控系统加分项简化说明文档



```
\# 服务器监控系统加分项简化说明文档

\## 一、Docker容器化部署类

\### 1. 监控应用全容器化部署

\- \*\*功能\*\*：通过Docker Compose一键编排前端、后端、MySQL服务，实现环境隔离与快速部署。

\- \*\*代码片段\*\*（\`docker-compose.yml\`）：

\`\`\`yaml

version: '3.8'

services:

 frontend:

   build: ./frontend

   ports: \["3000:3000"]

   environment:

     \- BACKEND\_URL=http://backend:5000

   depends\_on: \["backend"]

   restart: always

 backend:

   build: ./backend

   ports: \["5000:5000"]

   environment:

     \- MYSQL\_HOST=mysql

     \- MYSQL\_USER=monitor\_user

   depends\_on: \["mysql"]

   restart: always

   volumes: \["./backend/logs:/app/logs"]

 mysql:

   image: mysql:8.0

   ports: \["3307:3306"]

   environment:

     \- MYSQL\_ROOT\_PASSWORD=Root\_Encrypted

     \- MYSQL\_DATABASE=server\_monitor

     \- MYSQL\_USER=monitor\_user

     \- MYSQL\_PASSWORD=Encrypted\_123

   volumes: \["mysql\_data:/var/lib/mysql"]

   restart: always

volumes:

 mysql\_data:
```



* ![image-20251119211950257](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251119211950257.png)



### 2. 容器数据持久化与自动重启



* **功能**：MySQL 数据卷独立存储，容器删除后数据不丢失；所有服务异常自动重启。

* **代码片段**（`docker-compose.yml` 核心部分）：



```
services:

 mysql:

   volumes: \["mysql\_data:/var/lib/mysql"]  # 数据持久化

   restart: always  # 异常自动重启

 frontend:

   restart: always

 backend:

   restart: always

volumes:

 mysql\_data:  # 命名数据卷
```

![image-20251121142433487](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142433487.png)



## 二、可视化增强类

### 1. 响应式深色主题界面



* **功能**：基于 Bootstrap 实现 PC 自适应布局，默认深色主题，提升视觉体验。

* **代码片段**（`frontend/index.html`）：



```
\<meta name="viewport" content="width=device-width, initial-scale=1.0">

\<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

\<style>

/\* 默认深色主题 \*/

body {

 background-color: #121212;

 color: #e0e0e0;

}

.card {

 background-color: #1e1e1e;

 border: none;

}

\</style>

\<!-- 响应式布局 -->

\<div class="container mt-4">

 \<div class="row">

   \<div class="col-lg-3 col-12 mb-4">

     \<div class="card p-3">主机列表\</div>

   \</div>

   \<div class="col-lg-9 col-12">

     \<div class="card p-3">监控图表\</div>

   \</div>

 \</div>

\</div>
```



![image-20251121142501951](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142501951.png)



## 三、功能扩展类

### 1. 容器状态监控



* **功能**：采集并展示被监控主机的 Docker 容器资源使用数据（CPU、内存、状态）。

* **代码片段**（`backend/``container_monitor.py`）：



```
import paramiko

import json

def get\_container\_metrics(host\_ip, ssh\_user, ssh\_password):

   ssh = paramiko.SSHClient()

   ssh.set\_missing\_host\_key\_policy(paramiko.AutoAddPolicy())

   try:

       ssh.connect(host\_ip, username=ssh\_user, password=ssh\_password, timeout=10)

       # 采集容器资源数据

       stdin, stdout, stderr = ssh.exec\_command(

           "docker stats --no-stream --format '{{json .Container}} {{.CPUPerc}} {{.MemPerc}} {{.Name}}'"

       )

       containers = \[]

       for line in stdout.read().decode().split('\n'):

           if line.strip():

               cid, cpu, mem, name = line.strip().replace('"', '').split(' ', 3)

               containers.append({

                   "container\_id": cid\[:12],

                   "name": name,

                   "cpu\_usage": cpu,

                   "mem\_usage": mem,

                   "status": "running"

               })

       return containers

   finally:

       ssh.close()
```

![image-20251121142552273](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142552273.png)



### 2. 监控数据 Excel 导出



* **功能**：支持将指定时间范围的 CPU、内存监控数据导出为 Excel 文件，便于离线分析。

* **代码片段**（前端 `frontend/index.html` 导出按钮）：

```
\<!-- 导出按钮 -->

\<div class="card p-3 mb-4">

 \<div class="d-flex justify-content-between align-items-center">

   \<h5 class="mb-0">数据导出\</h5>

   \<button id="exportExcelBtn" class="btn btn-success">导出Excel\</button>

 \</div>

\</div>

\<script>

// 导出Excel事件

document.getElementById('exportExcelBtn').addEventListener('click', async () => {

 try {

   // 可添加时间范围选择逻辑，此处默认导出近24小时数据

   const response = await fetch('/api/export/metrics', {

     method: 'GET',

     responseType: 'blob'

   });

   // 处理Excel文件下载

   const blob = await response.blob();

   const url = window.URL.createObjectURL(blob);

   const a = document.createElement('a');

   a.href = url;

   a.download = \`监控数据\_\${new Date().toLocaleDateString()}.xlsx\`;

   document.body.appendChild(a);

   a.click();

   window.URL.revokeObjectURL(url);

   document.body.removeChild(a);

 } catch (error) {

   alert('导出失败：' + error.message);

 }

});

\</script>
```

* **代码片段**（后端 `backend/``export_service.py`）：

```
import pandas as pd

from datetime import datetime, timedelta

from flask import make\_response

import io

def export\_metrics\_to\_excel():

   """导出近24小时监控数据为Excel"""

   # 1. 查询数据库近24小时数据

   conn = get\_db\_connection()

   end\_time = datetime.now()

   start\_time = end\_time - timedelta(days=1)

   try:

       with conn.cursor(pymysql.cursors.DictCursor) as cursor:

           cursor.execute('''

               SELECT host\_ip, cpu\_usage, mem\_usage, collect\_time

               FROM metrics

               WHERE collect\_time BETWEEN %s AND %s

               ORDER BY collect\_time DESC

           ''', (start\_time.strftime('%Y-%m-%d %H:%M:%S'), end\_time.strftime('%Y-%m-%d %H:%M:%S')))

           data = cursor.fetchall()

   finally:

       conn.close()

   # 2. 转换为DataFrame并生成Excel

   df = pd.DataFrame(data)

   df.columns = \['主机IP', 'CPU使用率(%)', '内存使用率(%)', '采集时间']

  

   # 3. 写入Excel流

   output = io.BytesIO()

   with pd.ExcelWriter(output, engine='openpyxl') as writer:

       df.to\_excel(writer, sheet\_name='监控数据', index=False)

  

   # 4. 构建响应

   output.seek(0)

   response = make\_response(output.getvalue())

   response.headers\['Content-Type'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'

   response.headers\['Content-Disposition'] = f'attachment; filename=监控数据\_{end\_time.strftime("%Y%m%d")}.xlsx'

   return response

\# 后端接口注册（app.py中添加）

\# app.route('/api/export/metrics', methods=\['GET'])(export\_metrics\_to\_excel)
```

![image-20251121142713936](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142713936.png)



## 四、自动化部署类

### 1. 一键部署脚本



* **功能**：自动安装 Docker、Ansible 依赖，一键启动所有服务。

* **代码片段**（`deploy.sh`）：



```
\#!/bin/bash

set -e

\# 安装Docker

install\_docker() {

 if ! command -v docker &> /dev/null; then

   sudo apt update -y && sudo apt install -y docker.io docker-compose-plugin

   sudo systemctl enable --now docker

   sudo usermod -aG docker \$USER

 fi

}

\# 安装Ansible

install\_ansible() {

 if ! command -v ansible &> /dev/null; then

   sudo apt update -y && sudo apt install -y ansible sshpass

 fi

}

\# 启动服务

start\_services() {

 docker compose down && docker compose up -d --build

 server\_ip=\$(hostname -I | awk '{print \$1}')

 echo "服务启动成功，访问地址：http://\$server\_ip:3000"

}

install\_docker

install\_ansible

start\_services
```



## 五、服务稳定性增强类

### 1. 数据库连接重试机制



* **功能**：数据库连接失败时自动重试 3 次，避免临时网络波动。

* **代码片段**（`backend/``app.py`）：



```
import pymysql

import time

DB\_CONFIG = {

   'host': 'mysql',

   'user': 'monitor\_user',

   'password': 'Encrypted\_123',

   'db': 'server\_monitor'

}

def get\_db\_connection():

   max\_retries = 3

   retry\_delay = 2

   for retry in range(max\_retries):

       try:

           conn = pymysql.connect(\*\*DB\_CONFIG)

           return conn

       except Exception as e:

           if retry < max\_retries - 1:

               time.sleep(retry\_delay)

               continue

           raise Exception(f"数据库连接失败（已重试{max\_retries}次）：{str(e)}")
```

![image-20251121142948026](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142948026.png)

### 2. 服务启动自检



* **功能**：启动前检查数据库初始化、定时任务状态，确保服务正常运行。

* **代码片段**（`backend/``app.py`）：



```
from apscheduler.schedulers.background import BackgroundScheduler

def init\_database():

   conn = get\_db\_connection()

   try:

       with conn.cursor() as cursor:

           cursor.execute('''

               CREATE TABLE IF NOT EXISTS metrics (

                   id INT AUTO\_INCREMENT PRIMARY KEY,

                   host\_ip VARCHAR(20) NOT NULL,

                   cpu\_usage FLOAT NOT NULL,

                   mem\_usage FLOAT NOT NULL,

                   collect\_time DATETIME DEFAULT CURRENT\_TIMESTAMP

               )

           ''')

       conn.commit()

   finally:

       conn.close()

def scheduled\_data\_collection():

   pass  # 数据采集逻辑

\# 启动自检

if \_\_name\_\_ == '\_\_main\_\_':

   try:

       init\_database()

       scheduler = BackgroundScheduler()

       scheduler.add\_job(scheduled\_data\_collection, 'interval', seconds=10)

       scheduler.start()

       app.run(host='0.0.0.0', port=5000)

   except Exception as e:

       print(f"启动失败：{str(e)}")

       exit(1)
```

![image-20251121142909073](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142909073.png)

## 六、数据采集与处理类

### 1. 定时自动数据采集



* **功能**：每 10 秒自动采集所有主机的 CPU、内存数据。

* **代码片段**（`backend/``app.py`）：



```
def get\_all\_hosts():

   conn = get\_db\_connection()

   try:

       with conn.cursor(pymysql.cursors.DictCursor) as cursor:

           cursor.execute("SELECT ip, ssh\_user, ssh\_password FROM hosts")

           return cursor.fetchall()

   finally:

       conn.close()

def collect\_host\_metrics(host):

   return {

       'host\_ip': host\['ip'],

       'cpu\_usage': 25.3,  # 实际为解析结果

       'mem\_usage': 42.1

   }

def save\_metrics(metrics):

   conn = get\_db\_connection()

   try:

       with conn.cursor() as cursor:

           sql = "INSERT INTO metrics (host\_ip, cpu\_usage, mem\_usage) VALUES (%s, %s, %s)"

           cursor.execute(sql, (metrics\['host\_ip'], metrics\['cpu\_usage'], metrics\['mem\_usage']))

       conn.commit()

   finally:

       conn.close()

def scheduled\_data\_collection():

   hosts = get\_all\_hosts()

   for host in hosts:

       try:

           metrics = collect\_host\_metrics(host)

           save\_metrics(metrics)

       except Exception as e:

           print(f"采集失败：{str(e)}")
```

![image-20251121142830564](C:\Users\zeng\AppData\Roaming\Typora\typora-user-images\image-20251121142830564.png)



## 加分项汇总表



| 类别             | 加分项名称                      | 核心代码文件                                                 | 验证截图关键要求                                             |
| ---------------- | ------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Docker 容器化    | 全容器化部署                    | `docker-compose.yml`                                         | `docker-compose ps`显示所有容器`Up`                          |
| Docker 容器化    | 数据持久化 + 自动重启           | `docker-compose.yml`                                         | 重启容器后，Web 界面主机信息未丢失                           |
| 可视化增强       | 响应式深色主题界面              | `frontend/index.html`                                        | PC 端分栏 / 手机端堆叠布局截图                               |
| 功能扩展         | 容器监控                        | `backend/container_monitor.py`                               | Web 界面容器列表与 CPU / 内存数据表格                        |
| 自动化部署       | 一键部署脚本                    | `deploy.sh`                                                  | 浏览器成功打开 Web 界面的截图                                |
| 功能扩展         | 监控数据 Excel 导出             | `frontend/index.html`、`backend/export_service.py`           | 1. 前端导出按钮截图；2. 下载的 Excel 文件内容截图            |
| 服务稳定性       | 数据库连接重试                  | `backend/app.py`                                             | Web 界面正常展示数据库数据的截图                             |
| 服务稳定性       | 启动自检                        | `backend/app.py`                                             | Web 界面监控图表正常显示的截图                               |
| 数据采集功能扩展 | 定时自动采集监控数据 Excel 导出 | `backend/app.py``frontend/index.html`、`backend/export_service.py` | 监控图表 10 秒更新一次的动态截图1. 前端导出按钮截图；2. 下载的 Excel 文件内容截图 |



